---
title: "*DY* Data Dog's Breakfast"
author: "Johannes Burgers"
date: "6/23/2022"
output: rmdformats::html_clean
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'index.html')) })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning=FALSE, error=FALSE)
```

```{r}
library(tidyverse, quietly=TRUE)
library(ggthemes)
library(rmdformats)
library(cooccur)
library(plotly)
```


```{r preprocessing}
characters <- read_csv("data/characters.csv")
locations <- read_csv("data/locations.csv")
events <- read_csv("data/events.csv")
```

```{r clean_character}

characters_clean <- characters %>% 
                   select(SourceTextTitle:Family,Biography,Nid:IndividualGroup
                    ) %>% 
                   rename(CharacterID = Nid)
```

```{r clean_locations}
locations_clean <- locations %>% 
                   select(SourceTextTitle:Description,`True X`:Region) %>% 
                   rename_with(~gsub(" ", "_", .x, fixed = TRUE)) %>% 
                   mutate(across(contains('_'),~as.numeric(gsub(" ", "", .)))) %>% 
                   mutate(True_X = coalesce(True_X, Cemetery_X)) %>% 
                   mutate(True_Y = coalesce(True_Y, Cemetery_Y)) %>% 
                   select(!(Cemetery_X:Cemetery_Y)) %>% 
                   rename(LocationCode = LocationKey)
```


```{r events_clean}

events_clean <- events %>% 
                select(!c(Body:y,Keywords)) %>% 
                pivot_longer(c(CharactersPresent, CharactersMentioned), names_to = "PresentMentioned", values_to = "CharacterID") %>%                    
  separate_rows(CharacterID, sep = ",") %>% 
  mutate(CharacterID = as.numeric(str_trim(CharacterID))) %>% 
  mutate(PresentMentioned = str_remove_all(PresentMentioned, "Characters")) %>% 
  drop_na(CharacterID)
  
```

```{r full_database}

database_full <- events_clean %>% 
                 left_join(characters_clean) %>% 
                 left_join(locations_clean)  

```




## Introduction

The following is a series of charts and visualizations that were inspired by discussions for the NEH grant *Teaching and Learning William Faulkner in the Digital Age*. These discussions revolved around using the *Digital Yoknapatawpha* site to help enrich student understanding fo Faulkner at all levels through various technological interventions. The visualizations are not currently available on the official *DY* site, but have been created using the *DY* data.

## One is the loneliest number

One way to think about character representation in Faulkner's work is the number of occasions they appear alone. In essence, this is a character's "screen time." While the event data can provide frequency of times alone in a scene, it cannot shed light on duration. For example, a character who is alone two times throughout a novel in a very short sequence, is technically alone more than a character who is alone only once for two pages. These numbers can therefore be distorting at low-frequencies. Nevertheless, where the major characters are concerned these patterns tend to be somewhat more reliable.

### *The Sound and the Fury*


```{r compson_single}

compson_single <- database_full %>% 
                  filter(SourceTextCode == "SF") %>% 
                  filter(Family == "Compson") %>%  
                  filter(PresentMentioned == "Present") %>% 
                  group_by(Nid) %>% 
                  add_count(Nid) %>% 
                  filter(n == 1) %>% 
                  group_by(Gender) %>%  
                  count(CharacterName)

compson_events <- database_full %>% 
                  filter(SourceTextCode == "SF") %>% 
                  distinct(Nid) %>% 
                  nrow()

single_character_sf <-  database_full %>% 
                  filter(SourceTextCode == "SF") %>% 
                  filter(PresentMentioned == "Present") %>% 
                  group_by(Nid) %>% 
                  add_count(Nid) %>% 
                  filter(n == 1) %>% 
                  nrow()
                  

```

*The Sound and the Fury* has been broken down into `r compson_events` in `r single_character_sf` events, or `r round((single_character_sf/compson_events)*100,0)`% of the text, there is a character who is alone. This alone time is not equally distributed among the Compson family and is heavily tilted towards the men. What is remarkable is how little Caddy actually appears by herself, only once. Of course, it is easy to overlook one character who never appears alone at all Miss Quentin. Her narration is also in conjunction with others.

```{r}
compson_single %>%
  mutate(CharacterName = str_remove_all(CharacterName," Compson")) %>% 
  ggplot( aes(x=reorder(CharacterName,n), y=n, fill= Gender))+
  geom_bar(stat= "identity")+
    labs(title="Number of times Character Appears Alone", 
         x="Character", y = "Frequency")+
  geom_text(aes(label=n))+
  theme_clean()

```

The data suggests that the women of *SF* are rarely considered in isolation, and only exist on the page in relation to other characters. Meanwhile, we can also think about which Compsons are most spoken about in their absence. Here the exact opposite is true, women are spoken about more than they are present alone on the page. The only notable exception is Mr. Jason Compson who never appears alone, but is often mentioned. This is most likely an artifact of the Quentin section where he is mentioned quite often.



```{r sf_mentioned}

compson_mentioned <- database_full %>% 
                  filter(SourceTextCode == "SF") %>% 
                  filter(Family == "Compson") %>%  
                  filter(PresentMentioned == "Mentioned") %>% 
                  group_by(Gender) %>% 
                  count(CharacterName) %>% 
                  ungroup() %>% 
                top_n(10)

```

```{r sf_mentioned_plot}

compson_mentioned %>% 
   ggplot( aes(x=reorder(CharacterName,n), y=n, fill= Gender))+
  geom_bar(stat= "identity")+
    labs(title="Number of Times Characters are Mentioned", 
         x="Character", y = "Frequency")+
  geom_text(aes(label=n))+
  theme_clean()+
  coord_flip()

```

Yet a different way to consider the how the Compsons are represented is the narrative technique attached to them. Quite famously, Jason's section does not use the same stylistic pyrotechnics as that of Benjy and Quentin. This perhaps betrays his less varnished version of his family's travails. We can count the number of times each character is represented through a different technique, such as narrated, remembered, and told. 

```{r compson_narrative_status}

sf_narrative_status <- database_full %>% 
                      filter(SourceTextCode == "SF") %>% 
                  filter(Family == "Compson") %>% 
                  filter(PresentMentioned == "Present") %>% 
                    group_by(CharacterName) %>% 
                    count(NarrativeStatus) %>% 
                    mutate(percent = round(n/sum(n)*100,0)) %>% 
                    mutate(sum = sum(n)) %>% 
                  ungroup() %>% 
                    slice_max(sum, n=22)
                      
                    

```

```{r compson_narrative_status_plot}
sf_narrative_status %>% 
    ggplot( aes(x=reorder(CharacterName,NarrativeStatus), y=percent, fill= NarrativeStatus))+
    geom_bar(stat= "identity", color = "black")+
    labs(title="Percent Narrative Status per Character", 
         x="Character", y = "Percent")+
    coord_flip()+
    theme_clean()
```

The narrative status gives us different look at the Compson family history. The three sons are represented through narration and memory. Meanwhile, the parents and Caddy exist largely in memory. The newest member of the Compson family Miss Quentin exists most in the narrative present, and her life is largely narrated.

### *As I Lay Dying*

```{r bundren_single}

bundren_single <- database_full %>% 
                  filter(SourceTextCode == "LD") %>% 
                  filter(PresentMentioned == "Present") %>% 
                  group_by(Nid) %>% 
                  add_count(Nid) %>% 
                  filter(n == 1) %>% 
                  group_by(Gender) %>%  
                  count(CharacterName)

bundren_events <- database_full %>% 
                  filter(SourceTextCode == "LD") %>% 
                  distinct(Nid) %>% 
                  nrow()

single_character_aild <-  database_full %>% 
                  filter(SourceTextCode == "LD") %>% 
                  filter(PresentMentioned == "Present") %>% 
                  group_by(Nid) %>% 
                  add_count(Nid) %>% 
                  filter(n == 1) %>% 
                  nrow()
                  

```

*As I Lay Dying* differs substantially in how it represents characters. Not only are the perspectives interwoven throughout the text, the characters themselves are constantly entangled with one another. This is a novel in which characters are rarely alone. There are `r bundren_events` events in *As I Lay Dying*, of these only `r single_character_aild` events feature a character in isolation. This is `r round((single_character_aild/bundren_events)*100,0)`% of the novel, and noticeably less than *The SOund and the Fury*. This is also reflected in how often individual characters are alone.

```{r bundren_single_plot}
bundren_single %>%
  mutate(CharacterName = str_remove_all(CharacterName," Bundren")) %>% 
  ggplot( aes(x=reorder(CharacterName,n), y=n, fill= Gender))+
  geom_bar(stat= "identity")+
    labs(title="Number of Times Characters Appears Alone", 
         x="Character", y = "Frequency")+
  geom_text(aes(label=n))+
  theme_clean()+
  coord_flip()
```

Given the low frequency of characters appearing alone, it makes little sense to attach too much value to the relative differences between the characters who appear alone. More generally though, it indicates how intimately related to one another these characters are. 

Due to the spatial intimacy of the characters, it might be interesting to explore which characters tend to have the strongest relationships with one another. One way to measure this is through co-occurrence. Co-occurrence analysis determines how characters or groups of characters interact as a pattern. 

```{r co_occurrence}

co_occurrence_matrix <- database_full %>% 
  filter(SourceTextCode == "LD") %>% 
  filter(PresentMentioned == "Present") %>%
  filter(IndividualGroup == "Individual") %>%
  select(Nid, CharacterName) %>% 
    group_by(Nid) %>% 
  count(CharacterName) %>% 
  mutate(n = ifelse (n > 0, 1, 0)) %>% 
  pivot_wider(names_from = Nid,
              values_from = n,
              values_fill = 0)  %>% 
  column_to_rownames(var = "CharacterName")

```

```{r message=FALSE, warning=FALSE, include=FALSE}
aild_cooccur <-
  cooccur(
    mat = co_occurrence_matrix,
    type = "spp_site",
    thresh = FALSE,
    spp_names = TRUE,
    true_rand_classifier = 0.1,
    prob = "comb",
    site_mask = NULL,
    only_effects = FALSE,
    eff_standard = FALSE,
    eff_matrix = FALSE
  )
```

```{r}
aild_cooccur_table <- prob.table(aild_cooccur)
```

```{r}
tagged_prob_table <- aild_cooccur_table %>%
  mutate(
    relationship = case_when(
      p_lt < .05 ~ "Negative",
      p_lt > .05 & p_lt < .95 ~ "Random",
      p_lt > .95 ~ "Positive"
    )
  ) %>%
  arrange(sp1_name, sp2_name) %>%
  mutate(intersection = ifelse(
    sp1_name < sp2_name,
    paste(sp1_name, sp2_name, sep = "."),
    paste(sp2_name, sp1_name, sep = ".")
  )) %>% 
  filter(grepl('Bundren', sp1_name)) %>% 
  filter(grepl('Bundren', sp2_name)) 

top_table <- tagged_prob_table %>%
  filter(relationship != "Random") %>%
  group_by(relationship) %>%
  top_n(obs_cooccur, n = 5) %>%
  mutate(intersection = str_replace_all(intersection, c("_" =
                                                          " ", "\\." = "<br>"))) %>%
  ungroup() %>%
  arrange(relationship, obs_cooccur)

```

```{r}
top_table_plot <- plot_ly(
  top_table,
  x = ~ intersection,
  y = ~ obs_cooccur,
  type = "bar",
  color = ~relationship, 
  name = ~relationship,
  opacity=.9,
 # colors= faulkner_colorway,
  hovertemplate=paste("Observed Co-Occurrence: %{y}<br>", "Expected Co-Occurrence:", round(top_table$exp_cooccur,0), "<extra></extra>"),
  height = 600
 )

top_table_plot <- top_table_plot %>%
  layout(
    #font = plot_font,
    title = "Positive and Negative Co-Occurrences in the Bundren Family",
    xaxis = list(title = "Interaction", categoryorder = "trace"),
    yaxis = list(title = "Number of Events")
    #paper_bgcolor = faulkner_paperbackground,
  #  plot_bgcolor = faulkner_plotcolor,
   # modebar = list(bgcolor = faulkner_paperbackground),
  #  margin = m
  )

top_table_plot <- top_table_plot %>% 
            config(displayModeBar = FALSE)

top_table_plot
```

